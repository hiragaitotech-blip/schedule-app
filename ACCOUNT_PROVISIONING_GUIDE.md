# 企業の利用者にアカウントを発行する手順

## 📋 現在の機能

現在のシステムでは、**既存のテナント内**でユーザーを作成できます：
- `/settings/users` ページから、同じテナント内のユーザーを追加可能
- 管理者がメールアドレスとロールを指定してユーザーを作成
- 一時パスワードが自動生成され、ユーザーに共有

## ⚠️ 不足している機能

**新しい企業（テナント）を作成する機能がありません。**

現在は、SupabaseのSQL Editorで手動でテナントを作成する必要があります。

## 🔧 推奨される手順（現状）

### 方法1: Supabaseで手動作成（現在の方法）

1. **Supabaseダッシュボードにログイン**
2. **SQL Editorを開く**
3. **以下のSQLを実行**：

```sql
-- 1. 新しいテナント（企業）を作成
INSERT INTO public.tenants (name) 
VALUES ('株式会社○○人材紹介')
RETURNING id;

-- 2. テナントIDをコピー（例: '123e4567-e89b-12d3-a456-426614174000'）

-- 3. 管理者アカウントを作成（Supabase Authで手動作成）
-- または、既存の管理者アカウントにテナントを紐付け
UPDATE public.profiles 
SET tenant_id = '123e4567-e89b-12d3-a456-426614174000'::uuid
WHERE id = 'ユーザーID'::uuid;
```

### 方法2: 既存テナントにユーザーを追加（推奨）

既存のテナントがある場合：

1. **管理者でログイン**
2. **`/settings/users` にアクセス**
3. **「+ 新規ユーザー追加」ボタンをクリック**
4. **メールアドレスとロールを入力**
5. **「ユーザーを作成」をクリック**
6. **生成された一時パスワードをコピーしてユーザーに共有**

---

## 🚀 改善案：テナント管理機能の追加

以下の機能を追加することを推奨します：

### 1. テナント管理ページ（`/settings/tenants`）
- テナント一覧表示
- 新規テナント作成
- テナント名の編集

### 2. テナント作成API（`/api/tenants/create`）
- テナント作成
- 初期管理者アカウントの作成
- 一時パスワードの生成

### 3. 初回セットアップウィザード
- 初回ログイン時にテナント作成を案内
- 管理者アカウントのセットアップ

---

## 📝 現在の手順（詳細）

### ステップ1: テナントを作成

Supabase SQL Editorで実行：

```sql
-- テナント作成
INSERT INTO public.tenants (name) 
VALUES ('株式会社○○人材紹介')
RETURNING id, name;
```

**テナントIDをメモしてください**（例: `123e4567-e89b-12d3-a456-426614174000`）

### ステップ2: 管理者アカウントを作成

#### オプションA: 既存のユーザーを管理者にする

```sql
-- 既存のユーザーIDを確認
SELECT id, email FROM auth.users;

-- プロフィールを更新してテナントに紐付け
INSERT INTO public.profiles (id, tenant_id, role, is_active)
VALUES (
  '既存のユーザーID'::uuid,
  'テナントID'::uuid,
  'admin',
  true
)
ON CONFLICT (id) 
DO UPDATE SET 
  tenant_id = EXCLUDED.tenant_id,
  role = 'admin',
  is_active = true;
```

#### オプションB: 新しい管理者アカウントを作成

1. **Supabase Authでユーザーを作成**
   - Supabaseダッシュボード → Authentication → Users
   - 「Add user」をクリック
   - メールアドレスとパスワードを設定

2. **プロフィールを作成**

```sql
-- 作成したユーザーIDを確認
SELECT id, email FROM auth.users WHERE email = 'admin@example.com';

-- プロフィールを作成
INSERT INTO public.profiles (id, tenant_id, role, is_active)
VALUES (
  'ユーザーID'::uuid,
  'テナントID'::uuid,
  'admin',
  true
);
```

### ステップ3: ユーザーにアカウント情報を共有

1. **ログインURL**: `https://your-domain.com/login`
2. **メールアドレス**: 作成したメールアドレス
3. **パスワード**: 設定したパスワード（または一時パスワード）

### ステップ4: 追加ユーザーを作成

管理者でログイン後：

1. `/settings/users` にアクセス
2. 「+ 新規ユーザー追加」をクリック
3. メールアドレスとロールを入力
4. 生成された一時パスワードをユーザーに共有

---

## 🔐 セキュリティ注意事項

1. **一時パスワードは必ず安全な方法で共有**
   - メール、チャット、電話など
   - 初回ログイン時にパスワード変更を推奨

2. **管理者アカウントは最小限に**
   - 必要最小限のユーザーにのみ管理者権限を付与

3. **テナント分離の確認**
   - 各テナントのデータが正しく分離されているか確認

---

## ❓ よくある質問

### Q: 複数の企業を管理できますか？

**A: はい、可能です。** 各企業ごとにテナントを作成し、それぞれ独立して管理できます。

### Q: ユーザーは複数のテナントに所属できますか？

**A: 現在の実装では、1ユーザーは1テナントのみに所属できます。** 複数テナント対応が必要な場合は、実装を変更する必要があります。

### Q: テナントを削除できますか？

**A: 現在の実装では、テナント削除機能はありません。** 必要に応じて、Supabase SQL Editorで手動削除してください。

---

## 🎯 次のステップ

テナント管理機能を追加する場合は、以下のファイルを作成・修正します：

1. `app/settings/tenants/page.tsx` - テナント管理ページ
2. `app/api/tenants/create/route.ts` - テナント作成API
3. `src/components/tenants/TenantManagementClient.tsx` - テナント管理UI

実装が必要な場合は、お知らせください。

